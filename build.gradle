import org.ajoberstar.grgit.Grgit
import org.ajoberstar.grgit.operation.OpenOp
import org.ajoberstar.grgit.operation.CommitOp

buildscript {

    repositories {
        maven {
            url "http://dl.bintray.com/gesellix/gradle-plugins"
        }
        maven {
            url "https://jitpack.io"
        }
        mavenCentral()
        mavenLocal()
        jcenter()
    }

    dependencies {
        classpath "com.bmuschko:gradle-docker-plugin:2.4.1"
        classpath "de.gesellix:gradle-debian-plugin:16"
        classpath 'com.bmuschko:gradle-docker-plugin:2.4.1'
        classpath "org.ajoberstar:grgit:1.3.0"
    }

}

plugins {
    id 'idea'
    id 'sonar-runner'
    id 'net.researchgate.release' version '2.3.5'
}


repositories{
    mavenCentral()
}

ext {
    mesosVer = "0.25.0"
    imagePrefix = 'containersol'
}

idea {
    project {
        languageLevel = '1.8'
        vcs = 'Git'
    }
}

sonarRunner {
    sonarProperties {
        property "sonar.sourceEncoding", "UTF-8"
        property "sonar.dynamicAnalysis", "reuseReports"
        property "sonar.jacoco.reportPath", "${buildDir}/jacoco/test.exec"
    }
}

afterEvaluate {
}

task setVersionInBashScript << {
    println 'Will set version in bash script'
    ant.replace(file: "bin/minimesos", token: "MINIMESOS_TAG=\"latest\"", value: "MINIMESOS_TAG=\"${project.version}\"")

}
task resetVersionInBashScript << {
    println 'Will REset version in bash script'
    ant.replace(file: "bin/minimesos", token: "MINIMESOS_TAG=\"${project.version}\"", value: "MINIMESOS_TAG=\"latest\"")
}

task releaseMinimesosContainerImage << {
    println 'Will tag and push minimesos container'
}

task preTagCommitReplacement << {
    println 'Will set version in bash script'
    ant.replace(file: "bin/minimesos", token: "MINIMESOS_TAG=\"latest\"", value: "MINIMESOS_TAG=\"${project.version}\"")

    def grgit = new OpenOp().call()
    grgit.commit(message: '[Release] pre-tag commit', all: true)
    grgit.push(all: false)
}

preTagCommit.dependsOn preTagCommitReplacement
commitNewVersion.dependsOn resetVersionInBashScript

updateVersion.dependsOn releaseMinimesosContainerImage

// working around https://github.com/researchgate/gradle-release/issues/144
release {
    buildTasks = ['releaseBuild']
}

task releaseBuild {
    dependsOn(
        'minimesos:clean',
        'minimesos:build'
    )
}

